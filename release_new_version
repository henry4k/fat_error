#!/bin/bash
set -e

function luarocks
{
    luarocks-5.2 $@
}

version="$1"
rockspec_version="$version-0"
rockspec="rockspecs/fat_error-$rockspec_version.rockspec"
tag_name="v$version"

cat >"$rockspec" <<EOF
package = "fat_error"
version = "$rockspec_version"
source = {
   url = "https://github.com/henry4k/fat_error/archive/$tag_name.tar.gz",
   dir = "fat_error-$version"
}
description = {
   summary = "Replace error messages with error objects that store metadata.",
   detailed = [[
Errors can be chained e.g. for propagating out of a coroutine,
so you can print the error chain in a consistent manner.
Furthermore one can print the error to multiple destinations: A colored version
for the terminal, a colorless version for the log file, or even aggregate it in
a database for later processing/analysis.]],
   homepage = "https://github.com/henry4k/fat_error",
   license = "MIT"
}
dependencies = {
   "lua >= 5.2, < 5.4"
}
build = {
   type = "builtin",
   modules = {
      fat_error = "src/fat_error.lua",
      ["fat_error.Error"] = "src/fat_error/Error.lua",
      ["fat_error.Frame"] = "src/fat_error/Frame.lua",
      ["fat_error.utils.color"] = "src/fat_error/utils/color.lua",
      ["fat_error.utils.pretty_print"] = "src/fat_error/utils/pretty_print.lua",
      ["fat_error.writers.FancyWriter"] = "src/fat_error/writers/FancyWriter.lua"
   }
}
EOF
luarocks lint "$rockspec"
echo -n "Generated '$rockspec'.  Press return to continue ..." && read

git add "$rockspec"
git commit -m "Updated to $version"
git tag "$tag_name"

echo -n "Prepare for uploading data.  Press return to continue ..." && read
git push
git push --tags
luarocks upload "$rockspec"
